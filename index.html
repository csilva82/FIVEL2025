<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feira FIVEL 2025 - Mobile</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; }
canvas { display: block; }
#ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
#controls-info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; font-size: 14px; max-width: 300px; }
#controls-info h3 { margin-bottom: 10px; color: #4CAF50; }
#crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 20px; height: 20px; pointer-events: none; }
#crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(255,255,255,0.8); }
#crosshair::before { top: 50%; left: 0; width: 100%; height: 2px; transform: translateY(-50%); }
#crosshair::after { left: 50%; top: 0; width: 2px; height: 100%; transform: translateX(-50%); }
#hover-info { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(76,175,80,0.95); color: white; padding: 15px 30px; border-radius: 25px; font-size: 18px; font-weight: bold; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
#hover-info.visible { opacity: 1; }
#click-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(255,165,0,0.95); color: white; padding: 20px 40px; border-radius: 15px; font-size: 16px; font-weight: bold; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 500; }
#click-hint.visible { opacity: 1; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.05); } }
#minimap { 
  position: absolute; 
  top: 20px; 
  right: 20px; 
  width: 300px; 
  height: 200px; 
  background: rgba(0,0,0,0.9); 
  border: 3px solid #4CAF50; 
  border-radius: 10px; 
  pointer-events: all; 
  cursor: pointer; 
}
#minimap-title { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); color: #4CAF50; font-size: 13px; font-weight: bold; z-index: 10; }
#loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: white; font-size: 24px; background: rgba(0,0,0,0.9); padding: 30px 50px; border-radius: 15px; }
.hidden { display: none !important; }
#instructions { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.95); color: white; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px; pointer-events: all; }
#instructions h2 { color: #4CAF50; margin-bottom: 20px; }
#instructions button { background: #4CAF50; color: white; border: none; padding: 15px 40px; font-size: 18px; border-radius: 25px; cursor: pointer; margin-top: 20px; }
#custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; pointer-events: all; z-index: 1000; }
#modal-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; }
#modal-content h3 { color: white; font-size: 24px; margin-bottom: 15px; }
#modal-content p { color: rgba(255,255,255,0.9); font-size: 16px; margin-bottom: 10px; }
.url-display { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; color: #fff; font-family: monospace; font-size: 14px; margin: 20px 0; word-break: break-all; }
#modal-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 25px; }
#modal-buttons button { padding: 12px 30px; font-size: 16px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
#modal-visit { background: #4CAF50; color: white; }
#modal-cancel { background: rgba(255,255,255,0.2); color: white; }
#mobile-controls { position: absolute; bottom: 20px; left: 20px; display: none; pointer-events: all; z-index: 100; }
#mobile-controls.active { display: block; }
.control-pad { position: relative; width: 150px; height: 150px; }
.control-btn { position: absolute; width: 50px; height: 50px; background: rgba(76,175,80,0.7); border: 2px solid rgba(255,255,255,0.8); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; user-select: none; touch-action: none; }
.control-btn:active { background: rgba(76,175,80,0.95); transform: scale(0.95); }
.control-btn.up { top: 0; left: 50%; transform: translateX(-50%); }
.control-btn.down { bottom: 0; left: 50%; transform: translateX(-50%); }
.control-btn.left { top: 50%; left: 0; transform: translateY(-50%); }
.control-btn.right { top: 50%; right: 0; transform: translateY(-50%); }
#look-controls { position: absolute; bottom: 20px; right: 20px; display: none; pointer-events: all; z-index: 100; }
#look-controls.active { display: block; }
.look-pad { position: relative; width: 150px; height: 150px; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; touch-action: none; }
.look-indicator { position: absolute; width: 30px; height: 30px; background: rgba(255,255,255,0.8); border: 2px solid #4CAF50; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none; }
.look-label { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); color: white; font-size: 12px; font-weight: bold; }
@media (max-width: 768px) {
  #controls-info { display: none; }
  #minimap { top: 10px; right: 10px; width: 200px; height: 133px; }
  #hover-info { bottom: 200px; font-size: 14px; padding: 10px 20px; }
}
</style>
</head>
<body>
<div id="loading">Carregando Feira FIVEL 2025...</div>
<div id="instructions">
  <h2>üé™ Bem-vindo √† FIVEL 2025!</h2>
  <p style="margin: 20px 0;">Navegue pela feira virtual e clique nos estandes.</p>
  <p style="font-size: 14px; color: #ccc;">Use controles na tela ou WASD para mover.</p>
  <button id="start-btn">Entrar na Feira</button>
</div>
<div id="ui-overlay">
  <div id="controls-info">
    <h3>‚å®Ô∏è Controles</h3>
    <div>Teclas:W,A,S,D - Mover</div>
    <div>Mouse - Olhar</div>
    <div>Click - Interagir</div>
  </div>
  <div id="crosshair"></div>
  <div id="hover-info">üñ±Ô∏è Clique para visitar</div>
  <div id="click-hint">üñ±Ô∏è Clique aqui para continuar navegando</div>
  <div id="minimap"><div id="minimap-title">üó∫Ô∏è MAPA</div></div>
</div>
<div id="custom-modal" class="hidden">
  <div id="modal-content">
    <h3>üåê Visitar Site</h3>
    <p id="modal-text">Deseja visitar o site?</p>
    <div class="url-display" id="modal-url"></div>
    <div id="modal-buttons">
      <button id="modal-visit">‚úì Visitar</button>
      <button id="modal-cancel">‚úï Cancelar</button>
    </div>
  </div>
</div>
<div id="mobile-controls">
  <div class="control-pad">
    <div class="control-btn up" data-key="w">‚ñ≤</div>
    <div class="control-btn down" data-key="s">‚ñº</div>
    <div class="control-btn left" data-key="a">‚óÑ</div>
    <div class="control-btn right" data-key="d">‚ñ∫</div>
  </div>
</div>
<div id="look-controls">
  <div class="look-label">üëÄ Olhar</div>
  <div class="look-pad" id="look-pad">
    <div class="look-indicator"></div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const logosOnline = {
  "FIEMG e SENAI": "https://upload.wikimedia.org/wikipedia/commons/0/05/SENAI_logo_2024.png",
  "TDM": "http://www.tdm-mg.com.br/images/logo-copy.png",
  "Trivale": "https://www.trivale.com.br/imagens/logo.png",
};

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
scene.fog=new THREE.Fog(0x87ceeb,0,120);
const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
camera.position.set(-30, 1.7, -25);
camera.lookAt(new THREE.Vector3(-40, 1.7, 0));
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun=new THREE.DirectionalLight(0xffffff,0.8);
sun.position.set(30,40,30);
sun.castShadow=true;
scene.add(sun);
const floor=new THREE.Mesh(new THREE.PlaneGeometry(200,150),new THREE.MeshStandardMaterial({color:0xf0f0f0}));
floor.rotation.x=-Math.PI/2;
floor.receiveShadow=true;
scene.add(floor);
scene.add(new THREE.GridHelper(200,100,0xcccccc,0xe0e0e0));
const floorArea=new THREE.Mesh(new THREE.PlaneGeometry(80,60),new THREE.MeshStandardMaterial({color:0x888888}));
floorArea.rotation.x=-Math.PI/2;
floorArea.position.set(0,0.01,-5);
scene.add(floorArea);
const fairEdges=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(80,0.5,60)),new THREE.LineBasicMaterial({color:0xffff00}));
fairEdges.position.set(0,0.25,-5);
scene.add(fairEdges);
const interactiveStands=[];
const standPositions=[];

function createStand(x,z,w,d,c,l,u){
const g=new THREE.Group();
const base=new THREE.Mesh(new THREE.BoxGeometry(w,0.2,d),new THREE.MeshStandardMaterial({color:0x8B4513}));
base.position.y=0.1;
g.add(base);
const wall=new THREE.Mesh(new THREE.BoxGeometry(w,3,0.2),new THREE.MeshStandardMaterial({color:c}));
wall.position.set(0,1.5,d/2-0.1);
wall.castShadow=true;
g.add(wall);
const roof=new THREE.Mesh(new THREE.BoxGeometry(w,0.2,d),new THREE.MeshStandardMaterial({color:0xffffff}));
roof.position.y=3;
g.add(roof);
const panel=new THREE.Mesh(new THREE.BoxGeometry(w-0.5,2.5,0.1),new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:0.3}));
panel.position.set(0,1.5,d/2-0.15);
panel.userData={interactive:true,url:u,label:l};
g.add(panel);
interactiveStands.push(panel);
standPositions.push({x,z,width:w,depth:d,color:c,label:l,rotation:0});
const cv=document.createElement('canvas');
cv.width=512;cv.height=256;
const ctx=cv.getContext('2d');
ctx.fillStyle='#fff';
ctx.fillRect(0,0,512,256);

function drawTextOnly(){
  ctx.fillStyle='#fff';
  ctx.fillRect(0,0,512,256);
  ctx.fillStyle='#000';
  ctx.font='bold 40px Arial';
  ctx.textAlign='center';
  ctx.fillText(l,256,128);
}

const logoUrl = logosOnline[l];
const sign=new THREE.Mesh(new THREE.PlaneGeometry(Math.min(w*0.8,3.5),Math.min(w*0.8,3.5)*0.5),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cv)}));
sign.position.set(0,2.2,d/2-0.25);
sign.rotation.y=Math.PI;
g.add(sign);

if(logoUrl){
  const img=new Image();
  img.crossOrigin='anonymous';
  img.onload=()=>{
    ctx.fillStyle='#fff';
    ctx.fillRect(0,0,512,256);
    const maxW=400;
    const maxH=150;
    let imgW=img.width;
    let imgH=img.height;
    const ratio=Math.min(maxW/imgW,maxH/imgH);
    imgW*=ratio;
    imgH*=ratio;
    ctx.drawImage(img,(512-imgW)/2,(256-imgH)/2-30,imgW,imgH);
    ctx.fillStyle='#000';
    ctx.font='bold 24px Arial';
    ctx.textAlign='center';
    ctx.fillText(l,256,220);
    sign.material.map.needsUpdate=true;
  };
  img.onerror=()=>{
    drawTextOnly();
    sign.material.map.needsUpdate=true;
  };
  img.src=logoUrl;
}else{
  drawTextOnly();
}

g.position.set(x,0,z);
scene.add(g);
return g;
}

const s1=createStand(-15,-26.5,26.5,6,0x2c3e50,'FIEMG e SENAI','https://fiemg.com.br');
s1.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s2=createStand(-32,-20,7,3,0xffe600,'Credenciamento','https://www.fivel.com.br');
s2.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s3=createStand(21,-26.5,8,6,0x34495e,'ESPA√áO CIDADE CRIATIVA','https://www.espacocidadecriativa.com.br');
s3.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
createStand(21,-15,8,6,0x16a085,'SINDVEL SEBRAE','https://www.sindvel.com.br');
const s4=createStand(34.5,-20.5,10,18,0x8e44ad,'Rodadas Neg√≥cios','https://www.fivel.com.br/rodadas');
s4.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s5=createStand(38,9,8,3,0x2ecc71,'PSP Brasil','https://www.eps.com.br');
s5.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s6=createStand(-22,-14,3,3,0xaa96da,'TDM','http://www.tdm-mg.com.br/');
s6.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s7=createStand(-19,-14,3,3,0xff66cc,'Trivale','https://www.trivale.com.br');
s7.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s8=createStand(-22,-10,3,3,0xccff66,'Qualitronix','https://www.qualitronalt.com.br');
s8.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s9=createStand(-19,-10,3,3,0xff9999,'TSZU','https://www.tszu.com.br');
s9.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s10=createStand(-32,-14,3,3,0xff6b6b,'Metagal','https://www.metagil.com.br');
s10.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s11=createStand(-32,-10,3,3,0x4ecdc4,'Winpoint','https://www.winpoint.com.br');
s11.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s12=createStand(-32,-6,3,3,0xffe66d,'IDET','https://www.idet.com.br');
s12.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s13=createStand(-32,-2,3,3,0x95e1d3,'Sicredi','https://www.sicredi.com.br');
s13.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s14=createStand(-32,5,8,3,0xf38181,'Exxer/Exsto','https://www.Exxer.com.br');
s14.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s15=createStand(-22,-3.5,8,3,0x66ccff,'Think','https://www.tehal.com.br');
s15.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s16=createStand(-19,-6,3,3,0x66ffcc,'GMC','https://www.gmc.com.br');
s16.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s17=createStand(-19,-2,3,3,0xff6699,'Magneton','https://www.magneton.com.br');
s17.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s18=createStand(-22,3,3,3,0xffcc66,'ALPHA SUBSEA','https://www.alpharussia.com.br');
s18.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s19=createStand(-19,3,3,3,0x9966ff,'Enterplak','https://www.enterplak.com.br');
s19.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s20=createStand(-22,7,3,3,0x99ff99,'AMICUS','https://www.amicus.com.br');
s20.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s21=createStand(-19,7,3,3,0x66ff99,'RW','https://www.rw.com.br');
s21.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s22=createStand(-7,-14,3,3,0xffaa66,'Sensodron','https://www.sensodron.com.br');
s22.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s23=createStand(-4,-9,13,3,0xccaa66,'JFL','https://www.jfl.com.br');
s23.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s24=createStand(-4,-0.5,3,3,0x66ccaa,'Sense','https://www.sense.com.br');
s24.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s25=createStand(-4,5.5,8,3,0xaa66ff,'Leucotron','https://www.leucotron.com.br');
s25.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s26=createStand(-7,7.8,3.5,3,0xff9966,'FGM','https://www.fgm.com.br');
s26.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s27=createStand(-7,3.8,4.5,3,0x6666ff,'WatchGuard','https://www.watchguard.com.br');
s27.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s28=createStand(-7,-0.5,3,3,0xffcc99,'Serigr√°fica','https://www.serigr√°fica.com.br');
s28.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s29=createStand(-7,-4,3,3,0x66aaff,'ALPHA Pro','https://www.alphapro.com.br');
s29.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s30=createStand(-7,-9,6,3,0x66ff66,'RIA GREEN','https://www.riagreen.com.br');
s30.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s31=createStand(6,8.4,3,3,0xff6666,'Fractum','https://www.fractum.com.br');
s31.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s32=createStand(6,4.4,3,3,0x99ccff,'Nowigo','https://www.wowigo.com.br');
s32.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s33=createStand(16,-6,3,3,0xffff66,'Tamura','https://www.tamura.com.br');
s33.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s34=createStand(12,-6,3,3,0x996699,'Polimericos','https://www.polimericos.com.br');
s34.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s35=createStand(20,-6,3,3,0x99aa66,'Linear DEMINI','https://www.lineardemini.com.br');
s35.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s36=createStand(24,-6,3,3,0xaa9966,'Alarmes SRS','https://www.alarmessrs.com.br');
s36.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s37=createStand(14,8,6,3,0x6699aa,'Rocka Solutions','https://www.rockasolutions.com.br');
s37.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s38=createStand(17.5,9.5,3,3,0x66ffff,'ACEVALE','https://www.acervale.com.br');
s38.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
const s40=createStand(21.5,9.5,3,3,0xd35400,'Panasonic','https://www.panasonic.com.br');
s40.rotation.y=Math.PI;
standPositions[standPositions.length-1].rotation=Math.PI;
createStand(17.5,6.5,3,3,0x669966,'AGT Technologies','https://www.agttechnologies.com.br');
createStand(21.6,6.5,3,3,0xe74c3c,'Biotron','https://www.biotron.com.br');
const s43=createStand(38,16,3,4,0xff66ff,'DL','https://www.dl.com.br');
s43.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s44=createStand(29,6.5,3,3,0xaa6699,'Triunfo','https://www.triunfo.com.br');
s44.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s45=createStand(29,10,3,3,0xf39c12,'Elantas','https://www.elantas.com.br');
s45.rotation.y=Math.PI/2;
standPositions[standPositions.length-1].rotation=Math.PI/2;
const s46=createStand(32,6.5,3,3,0x996666,'Fuji','https://www.fuji.com.br');
s46.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
const s47=createStand(32,10,3,3,0x666699,'EPS','https://www.eps.com.br');
s47.rotation.y=-Math.PI/2;
standPositions[standPositions.length-1].rotation=-Math.PI/2;
createStand(-24,20,3,3,0x3498db,'Pixel','https://www.pixel.com.br');
createStand(-12,20,3,3,0x9b59b6,'AMS','https://www.ams.com.br');
createStand(-8,20,3,3,0xe67e22,'INATEL','https://www.inatel.br');
createStand(-4,20,3,3,0x1abc9c,'Tech Lab','https://www.techlab.com.br');
createStand(4,20,3,3,0x27ae60,'Alpha Tech','https://www.alphatech.com.br');
createStand(15,20,15,3,0x2c3e50,'Incubadoras','https://www.incubadoras.com.br');
createStand(32,20,15,3,0x34495e,'SINDICATO RURAL','https://www.sindicatorural.com.br');
const raycaster=new THREE.Raycaster();
let hoveredObject=null;
const keys={w:false,a:false,s:false,d:false};
let isPointerLocked=false;
const euler=new THREE.Euler(0,0,0,'YXZ');
const isMobile=/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<=768;

document.getElementById('start-btn').addEventListener('click',()=>{
document.getElementById('instructions').classList.add('hidden');
if(isMobile){
document.getElementById('mobile-controls').classList.add('active');
document.getElementById('look-controls').classList.add('active');
isPointerLocked=true;
}else{
renderer.domElement.requestPointerLock();
}
});

document.addEventListener('pointerlockchange',()=>{
if(!isMobile){
isPointerLocked=document.pointerLockElement===renderer.domElement;
if(!isPointerLocked && modal.classList.contains('hidden')){
document.getElementById('click-hint').classList.add('visible');
}else{
document.getElementById('click-hint').classList.remove('visible');
}
}
});

renderer.domElement.addEventListener('click',()=>{
if(!isMobile && !isPointerLocked && modal.classList.contains('hidden')){
document.getElementById('click-hint').classList.remove('visible');
renderer.domElement.requestPointerLock();
}
});

document.addEventListener('visibilitychange',()=>{
if(!document.hidden && !isMobile){
setTimeout(()=>{
if(modal.classList.contains('hidden') && !isPointerLocked){
document.getElementById('click-hint').classList.add('visible');
}
},500);
}
});

document.addEventListener('mousemove',(e)=>{
if(!isPointerLocked||isMobile)return;
euler.setFromQuaternion(camera.quaternion);
euler.y-=e.movementX*0.002;
euler.x-=e.movementY*0.002;
euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x));
camera.quaternion.setFromEuler(euler);
});

document.querySelectorAll('.control-btn').forEach(btn=>{
btn.addEventListener('touchstart',(e)=>{
e.preventDefault();
keys[btn.getAttribute('data-key')]=true;
});
btn.addEventListener('touchend',(e)=>{
e.preventDefault();
keys[btn.getAttribute('data-key')]=false;
});
});

const lookPad=document.getElementById('look-pad');
let touchId=null,centerX=0,centerY=0;
lookPad.addEventListener('touchstart',(e)=>{
e.preventDefault();
if(touchId===null&&e.touches.length>0){
const t=e.touches[0];
touchId=t.identifier;
const r=lookPad.getBoundingClientRect();
centerX=r.left+r.width/2;
centerY=r.top+r.height/2;
}
});
lookPad.addEventListener('touchmove',(e)=>{
e.preventDefault();
if(touchId!==null){
for(let i=0;i<e.touches.length;i++){
if(e.touches[i].identifier===touchId){
const t=e.touches[i];
const dx=t.clientX-centerX;
const dy=t.clientY-centerY;
euler.setFromQuaternion(camera.quaternion);
euler.y-=dx*0.001;
euler.x-=dy*0.001;
euler.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,euler.x));
camera.quaternion.setFromEuler(euler);
}
}
}
});
lookPad.addEventListener('touchend',(e)=>{
e.preventDefault();
for(let i=0;i<e.changedTouches.length;i++){
if(e.changedTouches[i].identifier===touchId){
touchId=null;
document.querySelector('.look-indicator').style.transform='translate(-50%,-50%)';
}
}
});

document.addEventListener('keydown',(e)=>{
const k=e.key.toLowerCase();
if(keys.hasOwnProperty(k))keys[k]=true;
});
document.addEventListener('keyup',(e)=>{
const k=e.key.toLowerCase();
if(keys.hasOwnProperty(k))keys[k]=false;
});

const modal=document.getElementById('custom-modal');
let pendingUrl=null;
function showModal(l,u){
pendingUrl=u;
document.getElementById('modal-text').textContent=`Visitar ${l}?`;
document.getElementById('modal-url').textContent=u;
modal.classList.remove('hidden');
if(document.pointerLockElement)document.exitPointerLock();
}

function hideModal(){
modal.classList.add('hidden');
pendingUrl=null;
if(!isMobile){
setTimeout(()=>{
if(!document.hidden){
renderer.domElement.requestPointerLock();
}
},300);
}
}

document.getElementById('modal-visit').addEventListener('click',()=>{
if(pendingUrl)window.open(pendingUrl,'_blank');
hideModal();
});
document.getElementById('modal-cancel').addEventListener('click',hideModal);

const hoverInfo=document.getElementById('hover-info');
function updateRaycaster(){
raycaster.setFromCamera(new THREE.Vector2(0,0),camera);
const hits=raycaster.intersectObjects(interactiveStands);
if(hits.length>0){
const obj=hits[0].object;
if(hoveredObject!==obj){
if(hoveredObject)hoveredObject.material.opacity=0.3;
hoveredObject=obj;
hoveredObject.material.opacity=0.6;
hoverInfo.textContent=`üñ±Ô∏è ${obj.userData.label}`;
hoverInfo.classList.add('visible');
}
}else{
if(hoveredObject){hoveredObject.material.opacity=0.3;hoveredObject=null;}
hoverInfo.classList.remove('visible');
}
}

document.addEventListener('click',()=>{
if(!isPointerLocked)return;
if(hoveredObject&&hoveredObject.userData.url){
showModal(hoveredObject.userData.label,hoveredObject.userData.url);
}
});

function updateMovement(){
if(!isPointerLocked)return;
const dir=new THREE.Vector3();
camera.getWorldDirection(dir);
dir.y=0;
dir.normalize();
const right=new THREE.Vector3();
right.crossVectors(camera.up,dir).normalize();
const vel=new THREE.Vector3();
if(keys.w)vel.add(dir);
if(keys.s)vel.sub(dir);
if(keys.a)vel.add(right);
if(keys.d)vel.sub(right);
if(vel.length()>0){
vel.normalize().multiplyScalar(0.15);
camera.position.add(vel);
camera.position.x=Math.max(-40,Math.min(40,camera.position.x));
camera.position.z=Math.max(-30,Math.min(20,camera.position.z));
}
}

const minimapCanvas=document.createElement('canvas');
minimapCanvas.width=600;
minimapCanvas.height=400;
minimapCanvas.style.width='100%';
minimapCanvas.style.height='100%';
const ctx=minimapCanvas.getContext('2d');
document.getElementById('minimap').appendChild(minimapCanvas);

function drawMinimap(){
ctx.clearRect(0,0,600,400);
ctx.fillStyle='#1a1a1a';
ctx.fillRect(0,0,600,400);
const scale = 5;
const offsetX = 300;
const offsetY = 200;
ctx.strokeStyle='#ff0';
ctx.lineWidth=3;
const fairWidth = 80 * scale;
const fairHeight = 60 * scale;
ctx.strokeRect(offsetX - fairWidth/2, offsetY - fairHeight/2, fairWidth, fairHeight);
standPositions.forEach(s=>{
const mx = offsetX + (s.x * scale);
const mz = offsetY + (s.z * scale);
ctx.save();
ctx.translate(mx, mz);
ctx.rotate(s.rotation || 0);
ctx.fillStyle=`#${s.color.toString(16).padStart(6,'0')}`;
ctx.fillRect(-s.width*scale/2, -s.depth*scale/2, s.width*scale, s.depth*scale);
ctx.strokeStyle='#000';
ctx.lineWidth=1;
ctx.strokeRect(-s.width*scale/2, -s.depth*scale/2, s.width*scale, s.depth*scale);
ctx.restore();
});
const px = offsetX + (camera.position.x * scale);
const pz = offsetY + (camera.position.z * scale);
ctx.fillStyle='#f00';
ctx.beginPath();
ctx.arc(px, pz, 8, 0, Math.PI*2);
ctx.fill();
ctx.strokeStyle='#fff';
ctx.lineWidth=2;
ctx.stroke();
const dir = new THREE.Vector3();
camera.getWorldDirection(dir);
ctx.strokeStyle='#fff';
ctx.lineWidth=3;
ctx.beginPath();
ctx.moveTo(px, pz);
ctx.lineTo(px + dir.x * 20, pz + dir.z * 20);
ctx.stroke();
}

minimapCanvas.addEventListener('click',(e)=>{
const r=minimapCanvas.getBoundingClientRect();
const x=(e.clientX-r.left)/r.width*600;
const y=(e.clientY-r.top)/r.height*400;
const scale = 5;
const offsetX = 300;
const offsetY = 200;
camera.position.x=Math.max(-40,Math.min(40,(x-offsetX)/scale));
camera.position.z=Math.max(-30,Math.min(20,(y-offsetY)/scale));
});

function animate(){
requestAnimationFrame(animate);
updateMovement();
updateRaycaster();
drawMinimap();
renderer.render(scene,camera);
}

window.addEventListener('resize',()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});

document.getElementById('loading').classList.add('hidden');
animate();
</script>
</body>
</html>
